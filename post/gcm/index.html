<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.2.0">
  <meta name="generator" content="Hugo 0.55.0" />

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Simon Kapitza">

  
  
  
    
  
  <meta name="description" content="Calculating cell-level 1st and 3rd quartiles and medians across Global Circulation Models">

  
  <link rel="alternate" hreflang="en-us" href="https://kapitzas.github.io/post/gcm/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#800020">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  

  <link rel="stylesheet" href="/styles.css">
  

  
  
  

  
  <link rel="alternate" href="https://kapitzas.github.io/index.xml" type="application/rss+xml" title="Simon Kapitza">
  <link rel="feed" href="https://kapitzas.github.io/index.xml" type="application/rss+xml" title="Simon Kapitza">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://kapitzas.github.io/post/gcm/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@@simonecology">
  <meta property="twitter:creator" content="@@simonecology">
  
  <meta property="og:site_name" content="Simon Kapitza">
  <meta property="og:url" content="https://kapitzas.github.io/post/gcm/">
  <meta property="og:title" content="Accounting for GCM uncertainty | Simon Kapitza">
  <meta property="og:description" content="Calculating cell-level 1st and 3rd quartiles and medians across Global Circulation Models"><meta property="og:image" content="https://kapitzas.github.io/img/si.jpg">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2021-03-11T00:00:00&#43;01:00">
  
  <meta property="article:modified_time" content="2021-03-11T00:00:00&#43;01:00">
  

  

  

  <title>Accounting for GCM uncertainty | Simon Kapitza</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Simon Kapitza</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#publications">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/files/cv.pdf">
            
            <span>CV</span>
            
          </a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Accounting for GCM uncertainty</h1>

  

  
    



<meta content="2021-03-11 00:00:00 &#43;0100 CET" itemprop="datePublished">
<meta content="2021-03-11 00:00:00 &#43;0100 CET" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    <time>Mar 11, 2021</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  

  

  
    

  

</div>

    







  









  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <p>I sometimes work with spatially downscaled future projections of bioclim variables (available for download on the <a href="http://www.worldclim.com/cmip5_30s" target="_blank">WorldClim website</a>). Since these data sets are quite large, it is tempting to just pick out one GCM without accounting for the variability of predictions between models.</p>

<p>For my first PhD paper (<a href="https://www.nature.com/articles/s41598-021-82474-z" target="_blank">Kapitza et al. 2021</a>) I made the effort of downloading GCM predictions (in this case under RCP 2.6 and RCP 8.5) and estimating the quartiles of the GCM predictions on each cell to account for GCM uncertainty.</p>

<p>Depending on the system this might take a few days to run, but in the end you have the lower and upper quartile and the median of projections made for each scenario and variable across all the different GCM, which helps to account for model uncertainty when using projected climate data.</p>

<p>These are the required packages:</p>

<pre><code>library(raster)
library(doParallel)
library(BBmisc)
</code></pre>

<p>This downloads the GCM predictions of the 19 bioclim variables at 0.5 arcmin resolution under RCP 2.6 and 8.5. Make sure you have around 100 GB of disk space for this.</p>

<pre><code>#--------------------------------#
#### 1. Download all GCM data ####
#--------------------------------#

# Resoltuion to be downloaded
res &lt;- 0.5

# RCP to be downloaded
scens &lt;- c(&quot;26&quot;, &quot;85&quot;)

# Which GCM are we inlcuding
models &lt;- c(&quot;GF&quot;, &quot;MP&quot;, &quot;BC&quot;, &quot;CC&quot;, &quot;CN&quot;, &quot;GS&quot;, &quot;HD&quot;, &quot;HE&quot;, &quot;IP&quot;, &quot;MI&quot;, &quot;MR&quot;, &quot;MC&quot;, &quot;MG&quot;, &quot;NO&quot;)

# Download to temp folder (will take a while, &gt; 30gb of data)
for(i in 1:length(models)){
  for (j in 1:length(scens)){
    f &lt;- tryCatch(raster::getData(&quot;CMIP5&quot;, rcp = scens[j], year = 70, model = models[i], res = res, var = &quot;bio&quot;, path = download_path), error = function (e) NA)
    if(class(f) != &quot;RasterStack&quot;){next}
  }
}
</code></pre>

<p>This next part loops through the required scenarios and variables, loading the data from all GCM for each variable and scenario. The data is then devided into 500 chunks (each still containing almost 1E6 cells) and processed in parallel. The chunks need to be processed in batches to make sure that the data returned from individual workers (which is combined into a matrix using rbind) doesn&rsquo;t exceed memory limits. Processed batches of chunks are stored to disk for the same reason. When all batches of a variable have been processed, they are loaded back in and written into a mask raster (you can create a mask from one of the downloaded layers). I ran this on a HPC cluster on 5 parallel cores and each variable took about 30 minutes to finish. So running this sequentially will probably take about 2.5 hours per processed variable.</p>

<pre><code>#------------------------------#
#### 2. Calculate quartiles ####
#------------------------------#
# For each variable and scenario, calcualtes the cell-wise quartiles across GCM.

# Load and make mask
cmip_layers &lt;- list.files(file.path(temp_path, &quot;cmip5&quot;), pattern = &quot;tif&quot;, full.names = TRUE, recursive = TRUE)
mask &lt;- raster(file.path(&quot;.&quot;, &quot;data&quot;, &quot;temp&quot;, &quot;mask.tif&quot;))

# Get non-na indices and divide them up into 500 chuncks (ecah  chunk still contains almost 1E6 cells)
inds &lt;- which(!is.na(mask[]))
inds_chunks &lt;- chunk(inds, n.chunks = 500)
inds_store &lt;- chunk(1:length(inds), n.chunks = 500)
proc_batch &lt;- chunk(1:500, n.chunks = 50)

qs &lt;- c(&quot;q1&quot;, &quot;q2&quot;, &quot;q3&quot;)
logfile &lt;- file.path(data_path, paste0(&quot;quantile_log.txt&quot;))
writeLines(c(&quot;&quot;), logfile)

# Loop through scenarios
for(i in 2:length(scens)) {
  
  # Loop through variables
  for(j in 1:19){
    
    # Load data from all GCM for current variable and scenairo
    fstack &lt;- stack(cmip_layers[grepl(cmip_layers, pattern = paste0(scens[i], &quot;bi70&quot;, j,&quot;.tif&quot;))])
    # Calcualte quantiles chunk by chunk
    
    # Loop thorugh processing batches (each includes 50 chunks)
    for(m in 1:length(proc_batch)){
      ks &lt;- proc_batch[[m]]
      # Loop through chunks
      
      cl &lt;- makeCluster(5)
      registerDoParallel(cl)
      
      quantiles &lt;- foreach(k = ks, .combine = rbind, .packages = c(&quot;matrixStats&quot;, &quot;raster&quot;)) %dopar% {
        cat(paste(&quot;scen &quot;, i, &quot; bio &quot;, j, &quot; chunk &quot;, k, &quot;\n&quot;), file = logfile, append = T)
        fstack_sub &lt;- fstack[inds_chunks[[k]]]
        matrixStats::rowQuantiles(fstack_sub, probs = c(0.25, 0.5, 0.75))
      }
      stopCluster(cl)
      
      # store batch to disk
      saveRDS(quantiles[,1], file.path(batch_path, paste0(&quot;q1_&quot;, sprintf(&quot;%02d&quot;, m), &quot;.rds&quot;)))
      saveRDS(quantiles[,2], file.path(batch_path, paste0(&quot;q2_&quot;, sprintf(&quot;%02d&quot;, m), &quot;.rds&quot;)))
      saveRDS(quantiles[,3], file.path(batch_path, paste0(&quot;q3_&quot;, sprintf(&quot;%02d&quot;, m), &quot;.rds&quot;)))
      
    }
    
    # load batches and write rasters
    for(l in 1:3) {
      cat(paste(&quot;writing quantile &quot;, qs[l], &quot; bio &quot;, j, &quot; scen &quot;, i, &quot;\n&quot;), file = logfile, append = T)
      qfiles &lt;- list.files(batch_path, pattern = qs[l], full.names = TRUE)
      out &lt;- numeric()
      
      for(p in 1:length(qfiles)){
        print(p)
        out &lt;- c(out, readRDS(qfiles[p]))
      }
      
      # write quantiles into raster files and store on disk
      q &lt;- mask
      q[inds] &lt;- out
      writeRaster(q, file.path(&quot;.&quot;, &quot;data&quot;, &quot;temp&quot;, &quot;output quartiles&quot;, paste0(qs[l], &quot;_&quot;, scens[i], &quot;bi70&quot;, j,&quot;.tif&quot;)), format = &quot;GTiff&quot;, overwrite = TRUE)
      unlink(qfiles)
    }
    
    # this is extremely memory-intensive, so we need to do some tidying up after eaach processed variable
    rm(out, q)
    gc()
    removeTmpFiles(h=0)
    # add link to Rs temp folder here
    unlink(list.files(&quot;/tmp&quot;, full.names = TRUE), recursive = T)
  }
}
</code></pre>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/r/">R</a>
  
  <a class="badge badge-light" href="/tags/worldclim/">worldclim</a>
  
</div>




    
      






  







<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  
  <img class="portrait mr-3" src="/author/admin/avatar_huf970f02ce1b4b8998adb4e8356b1063d_23397_250x250_fill_q90_lanczos_center.jpeg" itemprop="image" alt="Avatar">
  

  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/authors/admin">Simon Kapitza</a></h5>
    <h6 class="card-subtitle">PhD land-use and ecological modelling Research Assistant</h6>
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
        
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="mailto:simon.kapitza.research@gmail.com" >
          <i class="fas fa-envelope"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://twitter.com/simonecology" target="_blank" rel="noopener">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
      
      
      
      
        
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="https://github.com/kapitzas" target="_blank" rel="noopener">
          <i class="fab fa-github"></i>
        </a>
      </li>
      
      
      
      
      
      
      
      
        
      
      <li>
        <a itemprop="sameAs" href="/files/cv.pdf" >
          <i class="ai ai-cv"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/worldclimtiles/">Downloading and merging WorldClim tiles</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  <style>
* {
  box-sizing: border-box;
}

.column {
  float: left;
  width: 33%;
  padding: 0px;
}

 
.row::after {
  content: "";
  clear: both;
  display: table;
}
</style>
</head>
<body>
<div class="row">
  <div class="column">
      <a href="https://www.qaeco.com"><img src="/img/qaeco.png" alt="qaeco" style="width:70%"/></a>
  </div>
  <div class="column">
    <a href="https://www.unimelb.edu.au"><img src="/img/uom.jpeg" alt="unimelb" style="width:70%"/></a>
  </div>
    <div class="column">
    <a href=https://www.arc.gov.au><img src="/img/arc.jpg" alt="Forest" style="width:100%"/></a>
  </div>
</div>
<br>
  

  <p class="powered-by">
    &copy;2019 &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>




</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.9c79bd36ad5b530cf8825d78d951c339.js"></script>

  </body>
</html>

